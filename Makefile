# ============================================================================
# Makefile for Naver Connect Chatbot
# ============================================================================
# Docker ê´€ë ¨ ëª…ë ¹ì–´ë¥¼ ê°„í¸í•˜ê²Œ ì‹¤í–‰í•˜ê¸° ìœ„í•œ Makefileì…ë‹ˆë‹¤.
#
# ì‚¬ìš© ì˜ˆì‹œ:
#   make build     - Docker ì´ë¯¸ì§€ ë¹Œë“œ
#   make up        - ì„œë¹„ìŠ¤ ì‹œì‘
#   make down      - ì„œë¹„ìŠ¤ ì¤‘ì§€
#   make logs      - ë¡œê·¸ í™•ì¸
# ============================================================================

.PHONY: help build up down restart logs ps clean test health

# ê¸°ë³¸ íƒ€ê²Ÿ: help
.DEFAULT_GOAL := help

# ============================================================================
# í—¬í”„ ë©”ì‹œì§€
# ============================================================================
help:
	@echo "Naver Connect Chatbot - Docker ëª…ë ¹ì–´"
	@echo ""
	@echo "ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
	@echo "  make build          - Docker ì´ë¯¸ì§€ ë¹Œë“œ"
	@echo "  make build-nc       - ìºì‹œ ì—†ì´ Docker ì´ë¯¸ì§€ ë¹Œë“œ"
	@echo "  make up             - ì„œë¹„ìŠ¤ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)"
	@echo "  make up-logs        - ì„œë¹„ìŠ¤ ì‹œì‘ (ë¡œê·¸ ì¶œë ¥)"
	@echo "  make down           - ì„œë¹„ìŠ¤ ì¤‘ì§€"
	@echo "  make down-v         - ì„œë¹„ìŠ¤ ì¤‘ì§€ ë° ë³¼ë¥¨ ì‚­ì œ"
	@echo "  make restart        - ì„œë¹„ìŠ¤ ì¬ì‹œì‘"
	@echo "  make logs           - ëª¨ë“  ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸"
	@echo "  make logs-app       - App ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸"
	@echo "  make logs-qdrant    - Qdrant ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸"
	@echo "  make ps             - ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"
	@echo "  make health         - Health check"
	@echo "  make shell          - App ì»¨í…Œì´ë„ˆ ì‰˜ ì ‘ì†"
	@echo "  make shell-qdrant   - Qdrant ì»¨í…Œì´ë„ˆ ì‰˜ ì ‘ì†"
	@echo "  make clean          - ì¤‘ì§€ëœ ì»¨í…Œì´ë„ˆ ë° ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì œê±°"
	@echo "  make clean-all      - ëª¨ë“  Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬ (ì£¼ì˜!)"
	@echo "  make backup-qdrant  - Qdrant ë°ì´í„° ë°±ì—…"
	@echo "  make env            - .env íŒŒì¼ ìƒì„± (env.exampleì—ì„œ)"
	@echo ""

# ============================================================================
# í™˜ê²½ ì„¤ì •
# ============================================================================
env:
	@if [ ! -f .env ]; then \
		cp env.example .env; \
		echo "âœ… .env íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."; \
		echo "âš ï¸  .env íŒŒì¼ì„ ì—´ì–´ ì‹¤ì œ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."; \
	else \
		echo "âš ï¸  .env íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."; \
	fi

# ============================================================================
# ë¹Œë“œ ë° ì‹¤í–‰
# ============================================================================
build:
	@echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
	docker compose build

build-nc:
	@echo "ğŸ”¨ ìºì‹œ ì—†ì´ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
	docker compose build --no-cache

up:
	@echo "ğŸš€ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
	docker compose up -d
	@echo "âœ… ì„œë¹„ìŠ¤ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
	@echo "ğŸ“Š ìƒíƒœ í™•ì¸: make ps"
	@echo "ğŸ“ ë¡œê·¸ í™•ì¸: make logs"

up-logs:
	@echo "ğŸš€ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘ (ë¡œê·¸ ì¶œë ¥)..."
	docker compose up

down:
	@echo "ğŸ›‘ ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘..."
	docker compose down
	@echo "âœ… ì„œë¹„ìŠ¤ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."

down-v:
	@echo "âš ï¸  ì„œë¹„ìŠ¤ ì¤‘ì§€ ë° ë³¼ë¥¨ ì‚­ì œ ì¤‘..."
	@read -p "ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N) " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		docker compose down -v; \
		echo "âœ… ì„œë¹„ìŠ¤ ì¤‘ì§€ ë° ë³¼ë¥¨ ì‚­ì œ ì™„ë£Œ"; \
	else \
		echo "âŒ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."; \
	fi

restart:
	@echo "ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
	docker compose restart
	@echo "âœ… ì„œë¹„ìŠ¤ê°€ ì¬ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."

# ============================================================================
# ë¡œê·¸ ë° ëª¨ë‹ˆí„°ë§
# ============================================================================
logs:
	@echo "ğŸ“ ëª¨ë“  ì„œë¹„ìŠ¤ ë¡œê·¸ (Ctrl+Cë¡œ ì¢…ë£Œ)"
	docker compose logs -f

logs-app:
	@echo "ğŸ“ App ì„œë¹„ìŠ¤ ë¡œê·¸ (Ctrl+Cë¡œ ì¢…ë£Œ)"
	docker compose logs -f app

logs-qdrant:
	@echo "ğŸ“ Qdrant ì„œë¹„ìŠ¤ ë¡œê·¸ (Ctrl+Cë¡œ ì¢…ë£Œ)"
	docker compose logs -f qdrant

ps:
	@echo "ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ:"
	@docker compose ps

health:
	@echo "ğŸ¥ Health check ì‹¤í–‰ ì¤‘..."
	@curl -f http://localhost:8000/health && echo "\nâœ… Health check ì„±ê³µ" || echo "\nâŒ Health check ì‹¤íŒ¨"

# ============================================================================
# ì»¨í…Œì´ë„ˆ ì ‘ì†
# ============================================================================
shell:
	@echo "ğŸš App ì»¨í…Œì´ë„ˆ ì‰˜ ì ‘ì†..."
	docker compose exec app /bin/bash

shell-qdrant:
	@echo "ğŸš Qdrant ì»¨í…Œì´ë„ˆ ì‰˜ ì ‘ì†..."
	docker compose exec qdrant /bin/bash

# ============================================================================
# ë°ì´í„° ê´€ë¦¬
# ============================================================================
backup-qdrant:
	@echo "ğŸ’¾ Qdrant ë°ì´í„° ë°±ì—… ì¤‘..."
	@BACKUP_FILE=qdrant-backup-$$(date +%Y%m%d-%H%M%S).tar.gz; \
	docker compose exec qdrant tar czf /tmp/backup.tar.gz -C /qdrant/storage .; \
	docker cp qdrant-vectordb:/tmp/backup.tar.gz ./$$BACKUP_FILE; \
	echo "âœ… ë°±ì—… ì™„ë£Œ: $$BACKUP_FILE"

# ============================================================================
# ì •ë¦¬
# ============================================================================
clean:
	@echo "ğŸ§¹ Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì¤‘..."
	docker system prune -f
	@echo "âœ… ì •ë¦¬ ì™„ë£Œ"

clean-all:
	@echo "âš ï¸  ëª¨ë“  Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì¤‘..."
	@read -p "ëª¨ë“  ì´ë¯¸ì§€, ì»¨í…Œì´ë„ˆ, ë³¼ë¥¨ì´ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N) " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		docker system prune -a --volumes -f; \
		echo "âœ… ëª¨ë“  ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì™„ë£Œ"; \
	else \
		echo "âŒ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."; \
	fi

# ============================================================================
# ê°œë°œìš©
# ============================================================================
rebuild:
	@echo "ğŸ”„ ì„œë¹„ìŠ¤ ì¬ë¹Œë“œ ë° ì¬ì‹œì‘..."
	$(MAKE) down
	$(MAKE) build
	$(MAKE) up
	@echo "âœ… ì¬ë¹Œë“œ ë° ì¬ì‹œì‘ ì™„ë£Œ"

rebuild-nc:
	@echo "ğŸ”„ ìºì‹œ ì—†ì´ ì„œë¹„ìŠ¤ ì¬ë¹Œë“œ ë° ì¬ì‹œì‘..."
	$(MAKE) down
	$(MAKE) build-nc
	$(MAKE) up
	@echo "âœ… ì¬ë¹Œë“œ ë° ì¬ì‹œì‘ ì™„ë£Œ"

