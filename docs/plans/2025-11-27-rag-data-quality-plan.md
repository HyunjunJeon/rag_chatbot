# RAG 데이터 품질·라우팅 개선 계획

## 목적
- 통합 코퍼스(노트북/미션/PDF/Slack)를 프로덕션 검색 경로와 정합시키고, 노이즈를 줄여 답변 품질을 높인다.
- 메타데이터 기반 라우팅을 도입해 도메인 혼선과 불필요한 토큰 소비를 최소화한다.
- 청킹·요약·계보 관리를 명문화해 재현성과 회귀 대응력을 높인다.

## 범위
- 프로덕션 설정 정합 (`QDRANT_COLLECTION_NAME`, BM25 경로)
- 데이터 정제(소스별) 및 청킹/요약 파이프라인
- 메타 기반 검색 라우팅 설계·구현
- 라인리지(버전·타임스탬프·해시) 필드 추가
- 검증 및 헬스체크

## 작업 스트림별 계획

### 1) 프로덕션 설정 정합
- 작업: `.env` 기본값을 `QDRANT_COLLECTION_NAME=naver_connect_docs`, `RETRIEVER_BM25_INDEX_PATH=sparse_index/unified_bm25`로 정렬. Qdrant 컬렉션 벡터 차원(1024) 확인·재생성 시 스키마 일치 여부 검증.
- 산출물: 설정 PR + 체크리스트(컬렉션 존재 여부, dim 일치, 인덱스 경로 로드 로그).
- 검증: `qdrant_client.get_collection` 확인 로그, 샘플 검색 smoke test.

### 2) 소스별 클린업
- Slack: 최종 사용본은 `document_chunks/slack_qa_auto_filtered/*_merged.json`. 추가 필터 규칙(공지/감사/모집/짧은 감사 스레드) 확장, 중복 질문 병합 설계(유사도 기반 대표 Q/A 선정). 필터 통계에 삭제 사유 추가.
- PDF: 인제스트 전 정규식으로 IP 경고/이미지 플레이스홀더/페이지 머리말 제거. 슬라이드 헤더·본문만 유지.
- 노트북/미션: 코드·출력·텍스트 분리 규칙 강화, 불필요 출력(진단 로그 등) 제거. 문제/정답/힌트 메타 유지.
- 산출물: 소스별 클린업 모듈 업데이트 + 전후 통계 로그.

### 3) 메타 기반 라우팅 (우선)
- 전략: 의도/쿼리 분석 결과로 `doc_type`·`course`·`week/generation` 필터 생성 → 1차 필터 검색 → 결과 부족 시 폴백.
- 구현 포인트:
  - Qdrant: payload 필터 사용(must/should)으로 스코프 축소.
  - BM25: 통합 인덱스 사용 시 상위 N 후 메타 필터+재가중치, 가능하면 doc_type별 인덱스 선택 지원.
  - `retrieve_node`: `retrieval_filters` 상태를 받아 하이브리드 래퍼에 전달, 0건 시 폴백 로그.
- 산출물: 라우팅 설계 메모 + 코드 PR + 회귀 테스트 케이스(필터 on/off).

### 4) 청킹/요약 개선(LLM 활용 포함)
- PDF: 슬라이드 섹션 단위 재그룹 후 LLM 요약 필드(`summary`) 추가, 이미지/캡션 제거. 원문은 보존.
- Slack: 스레드 내 연속 답변 병합, 유사 질문 dedup, LLM으로 핵심 조치 추출 옵션(`action_summary`).
- 노트북/미션: 코드 셀 요약(주석/시그니처 중심), 출력 셀 필요시만 유지. 문제 본문 vs 해설/힌트 분리.
- 캐싱: 요약 결과를 청크 메타에 저장해 재호출 방지.
- 산출물: 소스별 후처리 파이프라인 + 요약 캐시 스키마.

### 5) 계보(라인리지) 필드
- 메타 필드: `corpus_version`, `processed_at`, `source_hash`, `pipeline`(예: slack_processed→merged→filtered vX).
- 전파: 청크 JSON → Qdrant payload → BM25 메타 → 헬스체크에서 버전 불일치 감지.
- 산출물: 필드 스키마 정의, 헬스체크 로그(버전 mismatch 시 경고).

### 6) 검증/헬스체크
- Smoke: 설정 반영 후 샘플 질문으로 Slack/강의/미션 각각 기대 도메인으로 라우트되는지 확인.
- 품질 지표: 노이즈 제거율, 검색 Top-K 도메인 적합도, 응답 성공률(주관적/샘플) 기록.
- 회귀: 필터 on/off, 폴백 경로, 요약 미적용 시 동작 테스트.

## 실행 순서 (추천)
1. 설정 정합: `.env` 기본값 수정, 컬렉션 스키마 확인/재생성, BM25 경로 교정.  
2. 메타 라우팅 설계·구현: 필터 스키마/우선순위 정의 → `retrieve_node`·retriever 래퍼 적용 → 필터 부족 시 폴백 로직.  
3. 소스 클린업 확장: Slack 추가 필터/중복 병합 설계, PDF/노트북 클린업 규칙 적용.  
4. 청킹/요약 파이프라인 설계·구현: 요약 필드/캐시 스키마 정의 후 소스별 적용.  
5. 라인리지 필드 추가: 생성-인제스트-인덱스 전 단계에 공통 필드 삽입, 헬스체크 경고 추가.  
6. 검증: 샘플 질의 스모크, 필터/폴백 회귀, 노이즈 제거 통계 기록.  
7. 문서화: README/AGENTS/운영 가이드에 새 설정·헬스체크·파이프라인 반영.

## 리스크·주의
- Qdrant/BM25 버전 불일치로 인한 검색 품질 저하 → 헬스체크 경고 필수.
- LLM 요약 비용 증가 → 캐싱·배치 처리, 요약 대상 최소화.
- 과도한 필터로 검색 0건 가능 → 단계적 폴백과 로그 필요.
