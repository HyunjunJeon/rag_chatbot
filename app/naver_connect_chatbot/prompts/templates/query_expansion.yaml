_type: chat_messages
metadata:
  name: query_expansion
  description: Generate multiple search queries and extract retrieval filters
  version: "1.1"
  author: TPC
  last_updated: "2025-12-12"

messages:
  - role: system
    content: |
      ## Task
      다양한 검색 쿼리를 생성하고 타겟 검색을 위한 메타데이터 필터를 추출합니다.
      이 프롬프트는 이전 단계의 품질 분석 점수를 활용하여 확장 전략을 결정합니다.

      {data_source_context}

      ## Multi-Query Generation
      품질 평가 결과에 따라 3-5개의 다양한 검색 쿼리를 생성합니다:

      ### High Quality (clarity >= 0.7 AND specificity >= 0.7)
      - 상호 보완적인 관점의 쿼리 3개 생성
      - 원본 의도에 집중
      - 관련 개념 및 동의어로 확장

      ### Medium Quality (clarity >= 0.4 OR specificity >= 0.4)
      - 해석의 다양성을 고려한 쿼리 4개 생성
      - 좁은 의미와 넓은 의미의 해석 모두 포함
      - 맥락을 보완하는 쿼리 추가

      ### Low Quality (clarity < 0.4 AND specificity < 0.4)
      - 여러 해석 가능성을 열어둔 쿼리 5개 생성
      - 질문을 명확화하는 재구성 포함
      - 합리적인 범위 내에서 가장 넓게 커버

      ### Query Generation Rules
      1. 상호 보완적 관점 커버:
         - 정의 및 핵심 개념
         - 구현 절차 및 베스트 프랙티스
         - 문제 해결 및 흔한 실수
         - 대안 비교
         - 실제 활용 사례
      2. 쿼리 간 중복 없이 상호 배타적이어야 함
      3. AI/ML 도메인의 구체적인 용어 사용
      4. 모호한 표현을 정확한 용어로 대체
      5. 각 쿼리는 독립적이고 검색에 최적화되어야 함

      ## Korean Synonym Expansion
      검색 쿼리 생성 시 한국어 동의어와 관련 표현을 활용합니다:
      - 원본 쿼리의 핵심 용어에 대해 동의어 버전 쿼리 포함
      - 영어-한국어 혼용 쿼리 활용
      - 약어 사용 시 풀네임 버전 고려

      ## Filter Extraction
      질문에서 메타데이터 필터를 추출하여 검색 범위를 좁힙니다.

      ### Filter Fields
      - **doc_type**: Available Data Sources에 있는 문서 소스 타입 사용
        - "Slack에서", "슬랙에서" → ["slack_qa"]
        - "강의자료에서", "PDF에서", "슬라이드에서" → ["pdf"]
        - "노트북에서", "실습 코드에서" → ["notebook"]
        - "미션에서", "과제에서" → ["weekly_mission"]
        - "녹취록", "강의 내용" → ["lecture_transcript"]
        - 다중 선택 가능: ["slack_qa", "pdf"]

      - **course**: 검색할 과정 이름 (리스트)
        - 모호한 경우 일치하는 모든 과정 포함
        - 예: "CV 강의" → ["CV 이론", "level2_cv", "Computer Vision"]

      - **course_topic**: 과정 내 특정 주제 (예: "PyTorch", "Transformer", "CNN")

      - **generation**: 기수 정보 (예: "1기", "2기", "3기")

      - **filter_confidence**: 필터 추출 신뢰도 (0.0 ~ 1.0)
        - 1.0: 명시적이고 모호함 없음
        - 0.5-0.9: 언급되었으나 약간의 모호함 있음
        - 0.5 미만: 추론되었거나 매우 모호함

      ### Filter Extraction Rules
      - 명시적으로 언급된 경우에만 추출
      - 불확실하면 추측하지 말고 null로 남김
      - 지엽적인 필터보다는 포괄적인 필터 선호
      - 주제 키워드만으로 필터를 추론하지 말 것

      ## Intent-Specific Strategy
      - **SIMPLE_QA**: 핵심 개념 중심 쿼리 3개
      - **COMPLEX_REASONING**: 추론 단계별 쿼리 4-5개
      - **EXPLORATORY**: 주제 전반 탐색 쿼리 5개
      - **CLARIFICATION_NEEDED**: 명확화 재구성 쿼리 3개

      ## Output Format
      JSON 형식으로 반환합니다. 코드펜스 없이 JSON만 반환하세요:
      {
        "improved_queries": ["쿼리1", "쿼리2", "쿼리3"],
        "retrieval_filters": {
          "doc_type": ["pdf"],
          "course": ["CV 이론"],
          "course_topic": "CNN",
          "generation": null,
          "filter_confidence": 0.9
        }
      }

      ## Self-Validation (Before Returning)
      반환 전에 다음을 확인합니다:
      1. **쿼리 개수**: Intent에 맞는 3-5개 쿼리가 있는가?
      2. **다양성**: 각 쿼리가 서로 다른 관점을 다루는가?
      3. **검색성**: 모든 쿼리가 한국어로 검색에 최적화되어 있는가?
      4. **필터 정확성**: 명시적으로 언급된 필터만 추출했는가?
      5. **동의어 활용**: 최소 1개 쿼리에서 동의어/관련어를 활용했는가?

      ## Examples

      ### Example 1: Slack 질문 (High Quality)
      Question: "Slack에서 PyTorch 관련 질문 중에 learning rate 설정에 대해 답변 받은 게 있나요?"
      Intent: SIMPLE_QA
      Quality: clarity=0.9, specificity=0.85

      Output:
      {
        "improved_queries": [
          "PyTorch learning rate 설정 방법",
          "PyTorch 학습률 조정 최적화",
          "딥러닝 learning rate scheduler 사용법"
        ],
        "retrieval_filters": {
          "doc_type": ["slack_qa"],
          "course": null,
          "course_topic": "PyTorch",
          "generation": null,
          "filter_confidence": 0.95
        }
      }

      ### Example 2: 강의자료 질문 (Medium Quality)
      Question: "CV 강의자료에서 CNN 설명 부분 찾아주세요"
      Intent: SIMPLE_QA
      Quality: clarity=0.7, specificity=0.6

      Output:
      {
        "improved_queries": [
          "CNN 아키텍처 구조 설명",
          "Convolutional Neural Network 기본 개념",
          "합성곱 신경망 레이어 구성",
          "CNN 필터와 풀링 동작 원리"
        ],
        "retrieval_filters": {
          "doc_type": ["pdf"],
          "course": ["CV 이론", "level2_cv", "Computer Vision"],
          "course_topic": "CNN",
          "generation": null,
          "filter_confidence": 0.85
        }
      }

      ### Example 3: 필터 없는 일반 질문 (Low Quality)
      Question: "어텐션이 뭐예요?"
      Intent: SIMPLE_QA
      Quality: clarity=0.5, specificity=0.3

      Output:
      {
        "improved_queries": [
          "Attention mechanism 기본 개념 설명",
          "Self-Attention 작동 원리",
          "Transformer attention 구조",
          "어텐션 메커니즘 수식과 직관적 이해",
          "NLP에서 attention이 중요한 이유"
        ],
        "retrieval_filters": {
          "doc_type": null,
          "course": null,
          "course_topic": "Attention",
          "generation": null,
          "filter_confidence": 0.6
        }
      }

  - role: human
    content: |
      Question: {question}
      Intent: {intent}
      Quality Scores: clarity={clarity}, specificity={specificity}

      Generate diverse search queries and extract retrieval filters.

input_variables:
  - question
  - intent
  - clarity
  - specificity
  - data_source_context
